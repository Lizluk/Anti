--[[
    Emote Anywhere v4 ‚Äî WITH FAVORITES & CUSTOM ADD
    
    T√çNH NƒÇNG M·ªöI:
    ‚úÖ Add emote tr·ª±c ti·∫øp trong GUI (kh√¥ng c·∫ßn edit code)
    ‚úÖ Favorites system - ƒë√°nh d·∫•u emote y√™u th√≠ch
    ‚úÖ T·ª± ƒë·ªông l∆∞u favorites v√† custom emotes
    ‚úÖ Filter: All / Favorites / Custom
    
    C√ÅCH D√ôNG:
    1. Nh·∫≠p Animation ID v√† t√™n emote ‚Üí Nh·∫•n "‚ûï Add"
    2. Click ‚≠ê ƒë·ªÉ th√™m/b·ªè y√™u th√≠ch
    3. D√πng filter ƒë·ªÉ l·ªçc emotes
    4. Nh·∫•n "‚ñ∂" ƒë·ªÉ ph√°t, "üîí" ƒë·ªÉ lock
--]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LP = Players.LocalPlayer
local Char = LP.Character or LP.CharacterAdded:Wait()
local Hum = Char:WaitForChild("Humanoid")
local Animator = Hum:WaitForChild("Animator")

-- =============================================
-- LOAD LIZLUK (optional)
-- =============================================
pcall(function()
    loadstring(game:HttpGet(
        "https://raw.githubusercontent.com/Lizluk/Anti/refs/heads/main/Fe%20Emote"
    ))()
end)
task.wait(2)

-- =============================================
-- STORAGE PATHS
-- =============================================
local FAVORITES_PATH = "EmoteAnywhere/favorites.json"
local CUSTOM_EMOTES_PATH = "EmoteAnywhere/custom_emotes.json"

-- =============================================
-- DATA STRUCTURES
-- =============================================
local currentTrack = nil
local isLocked = false
local isPaused = false
local loopConn = nil
local currentFilter = "all" -- "all", "favorites", "custom"

local DEFAULTS = {
    "507766388","507766666","507766951","507776061",
    "507776159","507777826","507777347","180426354","180426388",
    "507760248","507760952","507761454","507762013","507763714",
    "507765644","616163682","616159736","616158929",
}

-- Default presets
local defaultPresets = {
    { name = "Dance 1", id = "507771019", default = true },
    { name = "Dance 2", id = "507776043", default = true },
    { name = "Dance 3", id = "507777268", default = true },
    { name = "Wave", id = "507770239", default = true },
    { name = "Point", id = "507770453", default = true },
    { name = "Cheer", id = "507770677", default = true },
    { name = "Laugh", id = "507770818", default = true },
}

local allEmotes = {}
local favorites = {}
local customEmotes = {}

-- =============================================
-- STORAGE FUNCTIONS
-- =============================================
local function ensureFolder()
    if not isfolder("EmoteAnywhere") then
        makefolder("EmoteAnywhere")
    end
end

local function saveFavorites()
    ensureFolder()
    local data = HttpService:JSONEncode(favorites)
    writefile(FAVORITES_PATH, data)
end

local function loadFavorites()
    ensureFolder()
    if isfile(FAVORITES_PATH) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(FAVORITES_PATH))
        end)
        if ok and data then
            favorites = data
        end
    end
end

local function saveCustomEmotes()
    ensureFolder()
    local data = HttpService:JSONEncode(customEmotes)
    writefile(CUSTOM_EMOTES_PATH, data)
end

local function loadCustomEmotes()
    ensureFolder()
    if isfile(CUSTOM_EMOTES_PATH) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(CUSTOM_EMOTES_PATH))
        end)
        if ok and data then
            customEmotes = data
        end
    end
end

-- =============================================
-- EMOTE MANAGEMENT
-- =============================================
local function isFavorite(emoteId)
    for _, fav in ipairs(favorites) do
        if fav == emoteId then return true end
    end
    return false
end

local function toggleFavorite(emoteId)
    if isFavorite(emoteId) then
        -- Remove
        for i, fav in ipairs(favorites) do
            if fav == emoteId then
                table.remove(favorites, i)
                break
            end
        end
    else
        -- Add
        table.insert(favorites, emoteId)
    end
    saveFavorites()
end

local function addCustomEmote(name, id)
    for _, emote in ipairs(customEmotes) do
        if emote.id == id then
            return false, "ID ƒë√£ t·ªìn t·∫°i!"
        end
    end
    
    table.insert(customEmotes, {
        name = name,
        id = id,
        custom = true
    })
    saveCustomEmotes()
    return true, "ƒê√£ th√™m emote!"
end

local function removeCustomEmote(id)
    for i, emote in ipairs(customEmotes) do
        if emote.id == id then
            table.remove(customEmotes, i)
            saveCustomEmotes()
            return true
        end
    end
    return false
end

local function getAllEmotes()
    allEmotes = {}
    
    -- Add defaults
    for _, emote in ipairs(defaultPresets) do
        table.insert(allEmotes, emote)
    end
    
    -- Add custom
    for _, emote in ipairs(customEmotes) do
        table.insert(allEmotes, emote)
    end
    
    return allEmotes
end

local function getFilteredEmotes()
    local filtered = {}
    
    if currentFilter == "all" then
        return getAllEmotes()
    elseif currentFilter == "favorites" then
        for _, emote in ipairs(getAllEmotes()) do
            if isFavorite(emote.id) then
                table.insert(filtered, emote)
            end
        end
    elseif currentFilter == "custom" then
        for _, emote in ipairs(getAllEmotes()) do
            if emote.custom then
                table.insert(filtered, emote)
            end
        end
    end
    
    return filtered
end

-- =============================================
-- ANIMATION ENGINE
-- =============================================
local function isDefault(id)
    id = tostring(id)
    for _, v in ipairs(DEFAULTS) do
        if id:find(v) then return true end
    end
    return false
end

local function PlayEmoteDirect(animId)
    if currentTrack then
        pcall(function() currentTrack:Stop(0) end)
        currentTrack = nil
    end

    local animObj = Instance.new("Animation")
    animObj.AnimationId = "rbxassetid://" .. tostring(animId)

    local ok, track = pcall(function()
        return Animator:LoadAnimation(animObj)
    end)
    if not ok or not track then
        return nil, "Kh√¥ng load ƒë∆∞·ª£c animation ID: " .. tostring(animId)
    end

    track.Priority = Enum.AnimationPriority.Action4
    track.Looped = true
    track:Play(0, 1, 1)

    currentTrack = track
    return track, nil
end

local function suppressDefaults()
    if not Animator then return end
    for _, t in ipairs(Animator:GetPlayingAnimationTracks()) do
        if t ~= currentTrack and t.Animation and isDefault(t.Animation.AnimationId) then
            pcall(function() t:Stop(0.1) end)
        end
    end
end

local function startLoop()
    if loopConn then loopConn:Disconnect() end
    loopConn = RunService.Heartbeat:Connect(function()
        if not isLocked or not currentTrack then return end
        if isPaused then
            pcall(function() currentTrack:AdjustSpeed(0) end)
            return
        end
        if not currentTrack.IsPlaying then
            pcall(function()
                currentTrack:Play(0, 1, 1)
                currentTrack.Priority = Enum.AnimationPriority.Action4
            end)
        end
        suppressDefaults()
    end)
end

-- =============================================
-- GUI CREATION
-- =============================================
local oldGui = LP.PlayerGui:FindFirstChild("EmoteAnywhereV4")
if oldGui then oldGui:Destroy() end

local SG = Instance.new("ScreenGui")
SG.Name = "EmoteAnywhereV4"
SG.ResetOnSpawn = false
SG.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
SG.Parent = LP.PlayerGui

-- Main Frame
local MF = Instance.new("Frame")
MF.Name = "Main"
MF.Size = UDim2.new(0, 320, 0, 500)
MF.Position = UDim2.new(0, 20, 0.5, -250)
MF.BackgroundColor3 = Color3.fromRGB(10, 10, 18)
MF.BorderSizePixel = 0
MF.Parent = SG
Instance.new("UICorner", MF).CornerRadius = UDim.new(0, 14)
local stroke = Instance.new("UIStroke", MF)
stroke.Color = Color3.fromRGB(130, 60, 230)
stroke.Thickness = 3

-- Title Bar
local TB = Instance.new("Frame")
TB.Size = UDim2.new(1, 0, 0, 40)
TB.BackgroundColor3 = Color3.fromRGB(90, 35, 165)
TB.BorderSizePixel = 0
TB.Parent = MF
Instance.new("UICorner", TB).CornerRadius = UDim.new(0, 14)

local TL = Instance.new("TextLabel")
TL.Size = UDim2.new(1, 0, 1, 0)
TL.BackgroundTransparency = 1
TL.Text = "üé≠ Emote Anywhere v4"
TL.TextColor3 = Color3.fromRGB(255, 255, 255)
TL.TextSize = 16
TL.Font = Enum.Font.GothamBold
TL.Parent = TB

-- Status Label
local SL = Instance.new("TextLabel")
SL.Size = UDim2.new(1, -10, 0, 20)
SL.Position = UDim2.new(0, 5, 0, 45)
SL.BackgroundTransparency = 1
SL.Text = "Tr·∫°ng th√°i: Ch·ªù..."
SL.TextColor3 = Color3.fromRGB(200, 200, 200)
SL.TextSize = 12
SL.Font = Enum.Font.Gotham
SL.Parent = MF

-- Add Custom Section
local AddSection = Instance.new("Frame")
AddSection.Size = UDim2.new(1, -10, 0, 95)
AddSection.Position = UDim2.new(0, 5, 0, 70)
AddSection.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
AddSection.BorderSizePixel = 0
AddSection.Parent = MF
Instance.new("UICorner", AddSection).CornerRadius = UDim.new(0, 8)

local AddLabel = Instance.new("TextLabel")
AddLabel.Size = UDim2.new(1, -10, 0, 18)
AddLabel.Position = UDim2.new(0, 5, 0, 3)
AddLabel.BackgroundTransparency = 1
AddLabel.Text = "‚ûï Th√™m Emote T√πy Ch·ªânh"
AddLabel.TextColor3 = Color3.fromRGB(180, 180, 255)
AddLabel.TextSize = 13
AddLabel.Font = Enum.Font.GothamBold
AddLabel.TextXAlignment = Enum.TextXAlignment.Left
AddLabel.Parent = AddSection

local NameBox = Instance.new("TextBox")
NameBox.Size = UDim2.new(1, -10, 0, 28)
NameBox.Position = UDim2.new(0, 5, 0, 23)
NameBox.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
NameBox.TextColor3 = Color3.fromRGB(255, 255, 255)
NameBox.PlaceholderText = "T√™n emote (VD: üíï Kawaii Pose)"
NameBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
NameBox.Text = ""
NameBox.TextSize = 12
NameBox.Font = Enum.Font.Gotham
NameBox.BorderSizePixel = 0
NameBox.Parent = AddSection
Instance.new("UICorner", NameBox).CornerRadius = UDim.new(0, 6)

local IdInputBox = Instance.new("TextBox")
IdInputBox.Size = UDim2.new(0, 200, 0, 28)
IdInputBox.Position = UDim2.new(0, 5, 0, 57)
IdInputBox.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
IdInputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
IdInputBox.PlaceholderText = "Animation ID (VD: 507771019)"
IdInputBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
IdInputBox.Text = ""
IdInputBox.TextSize = 12
IdInputBox.Font = Enum.Font.Gotham
IdInputBox.BorderSizePixel = 0
IdInputBox.Parent = AddSection
Instance.new("UICorner", IdInputBox).CornerRadius = UDim.new(0, 6)

local AddBtn = Instance.new("TextButton")
AddBtn.Size = UDim2.new(0, 95, 0, 28)
AddBtn.Position = UDim2.new(0, 210, 0, 57)
AddBtn.BackgroundColor3 = Color3.fromRGB(40, 160, 60)
AddBtn.Text = "‚ûï Add"
AddBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
AddBtn.TextSize = 13
AddBtn.Font = Enum.Font.GothamBold
AddBtn.BorderSizePixel = 0
AddBtn.Parent = AddSection
Instance.new("UICorner", AddBtn).CornerRadius = UDim.new(0, 6)

-- Filter Buttons
local FilterFrame = Instance.new("Frame")
FilterFrame.Size = UDim2.new(1, -10, 0, 35)
FilterFrame.Position = UDim2.new(0, 5, 0, 170)
FilterFrame.BackgroundTransparency = 1
FilterFrame.Parent = MF

local function makeFilterBtn(text, pos, filter)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 98, 0, 30)
    btn.Position = UDim2.new(0, pos, 0, 0)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.BorderSizePixel = 0
    btn.Parent = FilterFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    return btn
end

local AllBtn = makeFilterBtn("üìã All", 5, "all")
local FavBtn = makeFilterBtn("‚≠ê Favorites", 108, "favorites")
local CustomBtn = makeFilterBtn("‚ú® Custom", 211, "custom")

-- Emotes ScrollFrame
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1, -10, 0, 240)
ScrollFrame.Position = UDim2.new(0, 5, 0, 210)
ScrollFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
ScrollFrame.BorderSizePixel = 0
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.Parent = MF
Instance.new("UICorner", ScrollFrame).CornerRadius = UDim.new(0, 8)

local Layout = Instance.new("UIListLayout")
Layout.Padding = UDim.new(0, 3)
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.Parent = ScrollFrame

-- Control Buttons
local CtrlFrame = Instance.new("Frame")
CtrlFrame.Size = UDim2.new(1, -10, 0, 35)
CtrlFrame.Position = UDim2.new(0, 5, 0, 455)
CtrlFrame.BackgroundTransparency = 1
CtrlFrame.Parent = MF

local function makeCtrlBtn(text, pos, w, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, w, 0, 32)
    btn.Position = UDim2.new(0, pos, 0, 0)
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    btn.Font = Enum.Font.GothamBold
    btn.BorderSizePixel = 0
    btn.Parent = CtrlFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 7)
    return btn
end

local LockBtn = makeCtrlBtn("üîí Lock", 5, 95, Color3.fromRGB(35, 155, 60))
local UnlockBtn = makeCtrlBtn("üîì Unlock", 105, 95, Color3.fromRGB(170, 40, 40))
local PauseBtn = makeCtrlBtn("‚è∏ Pause", 205, 100, Color3.fromRGB(180, 120, 10))

-- =============================================
-- EMOTE BUTTONS
-- =============================================
local emoteButtons = {}

local function updateFilter(filter)
    currentFilter = filter
    
    -- Update button colors
    AllBtn.BackgroundColor3 = (filter == "all") and Color3.fromRGB(80, 50, 150) or Color3.fromRGB(40, 40, 60)
    FavBtn.BackgroundColor3 = (filter == "favorites") and Color3.fromRGB(80, 50, 150) or Color3.fromRGB(40, 40, 60)
    CustomBtn.BackgroundColor3 = (filter == "custom") and Color3.fromRGB(80, 50, 150) or Color3.fromRGB(40, 40, 60)
    
    refreshEmoteList()
end

local function createEmoteButton(emote, index)
    local btn = Instance.new("Frame")
    btn.Size = UDim2.new(1, -5, 0, 40)
    btn.BackgroundColor3 = Color3.fromRGB(35, 35, 55)
    btn.BorderSizePixel = 0
    btn.LayoutOrder = index
    btn.Parent = ScrollFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    -- Star button (favorite)
    local starBtn = Instance.new("TextButton")
    starBtn.Size = UDim2.new(0, 35, 0, 35)
    starBtn.Position = UDim2.new(0, 2, 0, 2.5)
    starBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    starBtn.Text = isFavorite(emote.id) and "‚≠ê" or "‚òÜ"
    starBtn.TextColor3 = Color3.fromRGB(255, 215, 0)
    starBtn.TextSize = 18
    starBtn.Font = Enum.Font.GothamBold
    starBtn.BorderSizePixel = 0
    starBtn.Parent = btn
    Instance.new("UICorner", starBtn).CornerRadius = UDim.new(0, 6)
    
    starBtn.MouseButton1Click:Connect(function()
        toggleFavorite(emote.id)
        starBtn.Text = isFavorite(emote.id) and "‚≠ê" or "‚òÜ"
        SL.Text = isFavorite(emote.id) and "‚≠ê ƒê√£ th√™m v√†o y√™u th√≠ch" or "‚òÜ ƒê√£ b·ªè kh·ªèi y√™u th√≠ch"
        SL.TextColor3 = Color3.fromRGB(255, 215, 0)
    end)
    
    -- Name label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -150, 0, 35)
    nameLabel.Position = UDim2.new(0, 42, 0, 2.5)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = emote.name .. (emote.custom and " ‚ú®" or "")
    nameLabel.TextColor3 = Color3.fromRGB(220, 200, 255)
    nameLabel.TextSize = 12
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = btn
    
    -- Play button
    local playBtn = Instance.new("TextButton")
    playBtn.Size = UDim2.new(0, 65, 0, 35)
    playBtn.Position = UDim2.new(1, -105, 0, 2.5)
    playBtn.BackgroundColor3 = Color3.fromRGB(40, 160, 60)
    playBtn.Text = "‚ñ∂ Play"
    playBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    playBtn.TextSize = 11
    playBtn.Font = Enum.Font.GothamBold
    playBtn.BorderSizePixel = 0
    playBtn.Parent = btn
    Instance.new("UICorner", playBtn).CornerRadius = UDim.new(0, 6)
    
    playBtn.MouseButton1Click:Connect(function()
        local track, err = PlayEmoteDirect(emote.id)
        if track then
            isLocked = true
            startLoop()
            SL.Text = "‚úÖ " .. emote.name .. " (locked)"
            SL.TextColor3 = Color3.fromRGB(80, 255, 110)
        else
            SL.Text = "‚ùå " .. (err or "L·ªói")
            SL.TextColor3 = Color3.fromRGB(255, 80, 80)
        end
    end)
    
    -- Delete button (only for custom)
    if emote.custom then
        local delBtn = Instance.new("TextButton")
        delBtn.Size = UDim2.new(0, 35, 0, 35)
        delBtn.Position = UDim2.new(1, -37, 0, 2.5)
        delBtn.BackgroundColor3 = Color3.fromRGB(160, 40, 40)
        delBtn.Text = "üóëÔ∏è"
        delBtn.TextSize = 14
        delBtn.Font = Enum.Font.GothamBold
        delBtn.BorderSizePixel = 0
        delBtn.Parent = btn
        Instance.new("UICorner", delBtn).CornerRadius = UDim.new(0, 6)
        
        delBtn.MouseButton1Click:Connect(function()
            removeCustomEmote(emote.id)
            SL.Text = "üóëÔ∏è ƒê√£ x√≥a: " .. emote.name
            SL.TextColor3 = Color3.fromRGB(255, 150, 50)
            refreshEmoteList()
        end)
    end
    
    return btn
end

function refreshEmoteList()
    -- Clear old buttons
    for _, btn in ipairs(emoteButtons) do
        btn:Destroy()
    end
    emoteButtons = {}
    
    -- Create new buttons
    local emotes = getFilteredEmotes()
    for i, emote in ipairs(emotes) do
        local btn = createEmoteButton(emote, i)
        table.insert(emoteButtons, btn)
    end
    
    -- Update canvas size
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #emotes * 43)
end

-- =============================================
-- BUTTON EVENTS
-- =============================================
AddBtn.MouseButton1Click:Connect(function()
    local name = NameBox.Text
    local id = IdInputBox.Text:match("%d+")
    
    if not name or name == "" then
        SL.Text = "‚ö†Ô∏è Nh·∫≠p t√™n emote!"
        SL.TextColor3 = Color3.fromRGB(255, 200, 50)
        return
    end
    
    if not id then
        SL.Text = "‚ö†Ô∏è Nh·∫≠p Animation ID h·ª£p l·ªá!"
        SL.TextColor3 = Color3.fromRGB(255, 200, 50)
        return
    end
    
    local ok, msg = addCustomEmote(name, id)
    if ok then
        SL.Text = "‚úÖ " .. msg
        SL.TextColor3 = Color3.fromRGB(80, 255, 110)
        NameBox.Text = ""
        IdInputBox.Text = ""
        refreshEmoteList()
    else
        SL.Text = "‚ùå " .. msg
        SL.TextColor3 = Color3.fromRGB(255, 80, 80)
    end
end)

AllBtn.MouseButton1Click:Connect(function()
    updateFilter("all")
end)

FavBtn.MouseButton1Click:Connect(function()
    updateFilter("favorites")
end)

CustomBtn.MouseButton1Click:Connect(function()
    updateFilter("custom")
end)

LockBtn.MouseButton1Click:Connect(function()
    if not currentTrack then
        for _, t in ipairs(Animator:GetPlayingAnimationTracks()) do
            if t.Animation and not isDefault(t.Animation.AnimationId) then
                currentTrack = t
                break
            end
        end
    end
    if currentTrack then
        isLocked = true
        startLoop()
        SL.Text = "‚úÖ Locked!"
        SL.TextColor3 = Color3.fromRGB(80, 255, 110)
    else
        SL.Text = "‚ö†Ô∏è Ph√°t emote tr∆∞·ªõc!"
        SL.TextColor3 = Color3.fromRGB(255, 200, 50)
    end
end)

UnlockBtn.MouseButton1Click:Connect(function()
    isLocked = false
    isPaused = false
    if loopConn then loopConn:Disconnect() end
    if currentTrack then pcall(function() currentTrack:Stop(0.3) end) end
    currentTrack = nil
    PauseBtn.Text = "‚è∏ Pause"
    PauseBtn.BackgroundColor3 = Color3.fromRGB(180, 120, 10)
    SL.Text = "ƒê√£ unlock"
    SL.TextColor3 = Color3.fromRGB(200, 200, 200)
end)

PauseBtn.MouseButton1Click:Connect(function()
    if not isLocked then
        SL.Text = "‚ö†Ô∏è Lock tr∆∞·ªõc!"
        SL.TextColor3 = Color3.fromRGB(255, 200, 50)
        return
    end
    if not isPaused then
        isPaused = true
        pcall(function() currentTrack:AdjustSpeed(0) end)
        PauseBtn.Text = "‚ñ∂ Resume"
        PauseBtn.BackgroundColor3 = Color3.fromRGB(30, 110, 190)
        SL.Text = "‚è∏ T·∫°m d·ª´ng"
        SL.TextColor3 = Color3.fromRGB(100, 180, 255)
    else
        isPaused = false
        pcall(function() currentTrack:AdjustSpeed(1) end)
        PauseBtn.Text = "‚è∏ Pause"
        PauseBtn.BackgroundColor3 = Color3.fromRGB(180, 120, 10)
        SL.Text = "‚úÖ ƒêang ch·∫°y"
        SL.TextColor3 = Color3.fromRGB(80, 255, 110)
    end
end)

-- Drag functionality
local drag, dragStart, startPos = false, nil, nil
TB.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        drag = true
        dragStart = input.Position
        startPos = MF.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if drag and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        MF.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        drag = false
    end
end)

-- =============================================
-- INITIALIZATION
-- =============================================
loadFavorites()
loadCustomEmotes()
getAllEmotes()
updateFilter("all")

-- Respawn handler
LP.CharacterAdded:Connect(function(c)
    Char = c
    Hum = c:WaitForChild("Humanoid")
    Animator = Hum:WaitForChild("Animator")
    isLocked = false
    isPaused = false
    currentTrack = nil
    if loopConn then loopConn:Disconnect() end
    SL.Text = "Respawn ‚Äî ch·ªçn emote l·∫°i"
    SL.TextColor3 = Color3.fromRGB(200, 200, 200)
end)

print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üé≠ Emote Anywhere v4 ‚Äî LOADED!")
print("‚úÖ Favorites system enabled")
print("‚úÖ Custom emotes enabled")
print("‚úÖ Auto-save enabled")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
